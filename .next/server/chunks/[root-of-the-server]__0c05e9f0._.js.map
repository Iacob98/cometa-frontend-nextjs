{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/T7/cometa/cometa-separated-projects/cometa-frontend-nextjs/src/lib/document-storage.ts"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\n// Persistent storage directories\nconst STORAGE_DIR = path.join(process.cwd(), '.tmp', 'documents');\nconst METADATA_FILE = path.join(STORAGE_DIR, 'metadata.json');\n\n// Ensure storage directory exists\nif (!fs.existsSync(STORAGE_DIR)) {\n  fs.mkdirSync(STORAGE_DIR, { recursive: true });\n}\n\n// Load metadata from file or initialize empty\nlet uploadedDocuments: Record<string, any[]> = {};\ntry {\n  if (fs.existsSync(METADATA_FILE)) {\n    const data = fs.readFileSync(METADATA_FILE, 'utf8');\n    uploadedDocuments = JSON.parse(data);\n  }\n} catch (error) {\n  console.warn('Could not load document metadata:', error);\n  uploadedDocuments = {};\n}\n\n// Save metadata to file\nfunction saveMetadata() {\n  try {\n    fs.writeFileSync(METADATA_FILE, JSON.stringify(uploadedDocuments, null, 2));\n  } catch (error) {\n    console.error('Could not save document metadata:', error);\n  }\n}\n\n// Helper functions for document storage\nexport function storeDocument(userId: string, document: any) {\n  if (!uploadedDocuments[userId]) {\n    uploadedDocuments[userId] = [];\n  }\n  uploadedDocuments[userId].push(document);\n  saveMetadata(); // Save to file\n  console.log('üìù Document stored:', {\n    userId,\n    documentId: document.id,\n    fileName: document.file_name,\n    totalUserDocs: uploadedDocuments[userId].length\n  });\n}\n\nexport function storeFile(documentId: string, fileBuffer: Buffer) {\n  const filePath = path.join(STORAGE_DIR, `${documentId}.bin`);\n  try {\n    fs.writeFileSync(filePath, fileBuffer);\n    console.log('üíæ File stored:', {\n      documentId,\n      fileSize: fileBuffer.length,\n      filePath\n    });\n  } catch (error) {\n    console.error('Error storing file:', error);\n  }\n}\n\nexport function getDocument(userId: string, documentId: string) {\n  const userDocuments = uploadedDocuments[userId] || [];\n  const document = userDocuments.find(doc => doc.id === documentId);\n  console.log('üîç Get document:', {\n    userId,\n    documentId,\n    totalUserDocs: userDocuments.length,\n    found: !!document,\n    fileName: document?.file_name\n  });\n  return document;\n}\n\nexport function getFile(documentId: string) {\n  const filePath = path.join(STORAGE_DIR, `${documentId}.bin`);\n  try {\n    if (fs.existsSync(filePath)) {\n      const file = fs.readFileSync(filePath);\n      console.log('üîç Get file:', {\n        documentId,\n        filePath,\n        found: true,\n        fileSize: file.length\n      });\n      return file;\n    } else {\n      console.log('üîç Get file:', {\n        documentId,\n        filePath,\n        found: false,\n        fileSize: undefined\n      });\n      return null;\n    }\n  } catch (error) {\n    console.error('Error reading file:', error);\n    return null;\n  }\n}\n\nexport function deleteDocument(userId: string, documentId: string) {\n  const userDocuments = uploadedDocuments[userId] || [];\n  const documentIndex = userDocuments.findIndex(doc => doc.id === documentId);\n\n  if (documentIndex !== -1) {\n    const deletedDoc = userDocuments.splice(documentIndex, 1)[0];\n    saveMetadata(); // Save to file\n\n    // Also delete the file content\n    const filePath = path.join(STORAGE_DIR, `${documentId}.bin`);\n    try {\n      if (fs.existsSync(filePath)) {\n        fs.unlinkSync(filePath);\n      }\n    } catch (error) {\n      console.error('Error deleting file:', error);\n    }\n\n    return deletedDoc;\n  }\n\n  return null;\n}\n\nexport function getUserDocuments(userId: string) {\n  return uploadedDocuments[userId] || [];\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/T7/cometa/cometa-separated-projects/cometa-frontend-nextjs/src/app/api/users/%5Bid%5D/documents/%5BdocumentId%5D/view/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getDocument, getFile } from '@/lib/document-storage';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string; documentId: string }> }\n) {\n  try {\n    const { id, documentId } = await params;\n\n    if (!id || !documentId) {\n      return NextResponse.json(\n        { error: 'User ID and Document ID are required' },\n        { status: 400 }\n      );\n    }\n\n    // First check if we have the actual file stored\n    const fileContent = getFile(documentId);\n    const document = getDocument(id, documentId);\n\n    console.log('üîç View Debug:', {\n      userId: id,\n      documentId,\n      hasFileContent: !!fileContent,\n      hasDocument: !!document,\n      documentFileName: document?.file_name\n    });\n\n    if (fileContent && document) {\n      // Create response with Blob for proper binary data handling\n      const blob = new Blob([fileContent], {\n        type: document.file_type || 'application/octet-stream'\n      });\n\n      // Properly encode filename for header\n      const encodedFilename = encodeURIComponent(document.file_name);\n\n      return new Response(blob, {\n        status: 200,\n        headers: {\n          'Content-Type': document.file_type || 'application/octet-stream',\n          'Content-Disposition': `inline; filename*=UTF-8''${encodedFilename}`,\n          'Content-Length': fileContent.length.toString(),\n        },\n      });\n    }\n\n    // Create a simple PDF content as placeholder\n    const pdfContent = `%PDF-1.4\n1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n/Resources <<\n/ProcSet [/PDF /Text]\n/Font <<\n/F1 5 0 R\n>>\n>>\n>>\nendobj\n\n4 0 obj\n<<\n/Length 110\n>>\nstream\nBT\n/F1 16 Tf\n100 700 Td\n(–î–æ–∫—É–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–∞) Tj\n0 -30 Td\n/F1 12 Tf\n(ID –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${documentId}) Tj\n0 -20 Td\n(ID —Ä–∞–±–æ—Ç–Ω–∏–∫–∞: ${id}) Tj\n0 -20 Td\n(–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) Tj\nET\nendstream\nendobj\n\n5 0 obj\n<<\n/Type /Font\n/Subtype /Type1\n/BaseFont /Helvetica\n>>\nendobj\n\nxref\n0 6\n0000000000 65535 f\n0000000010 00000 n\n0000000053 00000 n\n0000000110 00000 n\n0000000297 00000 n\n0000000455 00000 n\ntrailer\n<<\n/Size 6\n/Root 1 0 R\n>>\nstartxref\n522\n%%EOF`;\n\n    // Return the mock PDF with inline content disposition for viewing\n    return new Response(pdfContent, {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/pdf',\n        'Content-Disposition': `inline; filename=\"document-${documentId}-view.pdf\"`,\n        'Content-Length': pdfContent.length.toString(),\n      },\n    });\n  } catch (error) {\n    console.error('Document view API error:', error);\n    return NextResponse.json(\n      { error: 'Failed to view document' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAA2D;IAEnE,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,UAAU,EAAE,GAAG,MAAM;QAEjC,IAAI,CAAC,MAAM,CAAC,YAAY;YACtB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuC,GAChD;gBAAE,QAAQ;YAAI;QAElB;QAEA,gDAAgD;QAChD,MAAM,cAAc,IAAA,8IAAO,EAAC;QAC5B,MAAM,WAAW,IAAA,kJAAW,EAAC,IAAI;QAEjC,QAAQ,GAAG,CAAC,kBAAkB;YAC5B,QAAQ;YACR;YACA,gBAAgB,CAAC,CAAC;YAClB,aAAa,CAAC,CAAC;YACf,kBAAkB,UAAU;QAC9B;QAEA,IAAI,eAAe,UAAU;YAC3B,4DAA4D;YAC5D,MAAM,OAAO,IAAI,KAAK;gBAAC;aAAY,EAAE;gBACnC,MAAM,SAAS,SAAS,IAAI;YAC9B;YAEA,sCAAsC;YACtC,MAAM,kBAAkB,mBAAmB,SAAS,SAAS;YAE7D,OAAO,IAAI,SAAS,MAAM;gBACxB,QAAQ;gBACR,SAAS;oBACP,gBAAgB,SAAS,SAAS,IAAI;oBACtC,uBAAuB,CAAC,yBAAyB,EAAE,iBAAiB;oBACpE,kBAAkB,YAAY,MAAM,CAAC,QAAQ;gBAC/C;YACF;QACF;QAEA,6CAA6C;QAC7C,MAAM,aAAa,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eA0CT,EAAE,WAAW;;eAEb,EAAE,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KA8Bf,CAAC;QAEF,kEAAkE;QAClE,OAAO,IAAI,SAAS,YAAY;YAC9B,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,uBAAuB,CAAC,2BAA2B,EAAE,WAAW,UAAU,CAAC;gBAC3E,kBAAkB,WAAW,MAAM,CAAC,QAAQ;YAC9C;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA0B,GACnC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}