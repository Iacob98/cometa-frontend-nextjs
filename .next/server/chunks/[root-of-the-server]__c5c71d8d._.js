module.exports = [
"[project]/.next-internal/server/app/api/documents/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/src/app/api/documents/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
;
;
;
const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://oijmohlhdxoawzvctnxx.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pam1vaGxoZHhvYXd6dmN0bnh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODUzMjcsImV4cCI6MjA3MDg2MTMyN30.vw9G5hcSfd-m5AZqeGlmzGvqc9ImYioDFR-AsiHoFro"));
// Validation schema for document metadata
const DocumentSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    project_id: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid("Invalid project ID").optional(),
    filename: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, "Filename is required"),
    original_filename: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    file_type: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    file_size: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].number().positive().optional(),
    document_type: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().default('general'),
    category_id: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid("Invalid category ID").optional(),
    description: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    uploaded_by: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid("Invalid user ID").optional(),
    is_active: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].boolean().default(true)
});
async function GET(request) {
    try {
        const { searchParams } = new URL(request.url);
        const page = parseInt(searchParams.get("page") || "1");
        const per_page = parseInt(searchParams.get("per_page") || "20");
        const offset = (page - 1) * per_page;
        const project_id = searchParams.get("project_id");
        const document_type = searchParams.get("document_type");
        const category_id = searchParams.get("category_id");
        const file_type = searchParams.get("file_type");
        const uploaded_by = searchParams.get("uploaded_by");
        const search = searchParams.get("search");
        const is_active = searchParams.get("is_active");
        const date_from = searchParams.get("date_from");
        const date_to = searchParams.get("date_to");
        let query = supabase.from("documents").select(`
        id,
        project_id,
        filename,
        original_filename,
        file_type,
        file_size,
        document_type,
        category_id,
        description,
        upload_date,
        uploaded_by,
        is_active,
        created_at,
        updated_at,
        projects(id, name, city),
        document_categories(id, code, name_de, name_ru, name_en),
        users:users!documents_uploaded_by_fkey(id, first_name, last_name, email)
      `, {
            count: "exact"
        }).order("upload_date", {
            ascending: false
        }).range(offset, offset + per_page - 1);
        // Apply filters
        if (project_id) {
            query = query.eq("project_id", project_id);
        }
        if (document_type) {
            query = query.eq("document_type", document_type);
        }
        if (category_id) {
            query = query.eq("category_id", category_id);
        }
        if (file_type) {
            query = query.eq("file_type", file_type);
        }
        if (uploaded_by) {
            query = query.eq("uploaded_by", uploaded_by);
        }
        if (is_active !== null) {
            query = query.eq("is_active", is_active === "true");
        }
        if (date_from) {
            query = query.gte("upload_date", date_from);
        }
        if (date_to) {
            query = query.lte("upload_date", date_to);
        }
        if (search) {
            query = query.or(`filename.ilike.%${search}%,original_filename.ilike.%${search}%,description.ilike.%${search}%,document_type.ilike.%${search}%`);
        }
        const { data: documents, error, count } = await query;
        if (error) {
            console.error("Supabase error:", error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Failed to fetch documents from database"
            }, {
                status: 500
            });
        }
        // Enhance data with calculated fields
        const enhancedDocuments = (documents || []).map((doc)=>{
            const project = Array.isArray(doc.projects) ? doc.projects[0] : doc.projects;
            const category = Array.isArray(doc.document_categories) ? doc.document_categories[0] : doc.document_categories;
            const uploader = Array.isArray(doc.users) ? doc.users[0] : doc.users;
            return {
                ...doc,
                project_name: project?.name || "No Project",
                project_city: project?.city || "Unknown City",
                category_name: category?.name_en || category?.name_de || "Uncategorized",
                category_code: category?.code || null,
                uploader_name: uploader ? `${uploader.first_name} ${uploader.last_name}` : "Unknown User",
                uploader_email: uploader?.email || null,
                file_size_mb: doc.file_size ? (doc.file_size / (1024 * 1024)).toFixed(2) : null,
                upload_date_formatted: doc.upload_date ? new Date(doc.upload_date).toLocaleDateString() : null
            };
        });
        // Calculate summary statistics
        const documentTypeCounts = enhancedDocuments.reduce((acc, doc)=>{
            acc[doc.document_type] = (acc[doc.document_type] || 0) + 1;
            return acc;
        }, {});
        const fileTypeCounts = enhancedDocuments.reduce((acc, doc)=>{
            if (doc.file_type) {
                acc[doc.file_type] = (acc[doc.file_type] || 0) + 1;
            }
            return acc;
        }, {});
        const totalSize = enhancedDocuments.reduce((sum, doc)=>sum + (doc.file_size || 0), 0);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            items: enhancedDocuments,
            total: count || 0,
            page,
            per_page,
            total_pages: Math.ceil((count || 0) / per_page),
            summary: {
                document_type_counts: documentTypeCounts,
                file_type_counts: fileTypeCounts,
                total_size_bytes: totalSize,
                total_size_mb: (totalSize / (1024 * 1024)).toFixed(2),
                active_documents: enhancedDocuments.filter((doc)=>doc.is_active).length,
                inactive_documents: enhancedDocuments.filter((doc)=>!doc.is_active).length
            }
        });
    } catch (error) {
        console.error("Documents API error:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to fetch documents"
        }, {
            status: 500
        });
    }
}
async function POST(request) {
    try {
        const body = await request.json();
        // Validate request body with Zod
        const validationResult = DocumentSchema.safeParse(body);
        if (!validationResult.success) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Validation failed",
                details: validationResult.error.issues
            }, {
                status: 400
            });
        }
        const validatedData = validationResult.data;
        // Verify project exists if project_id is provided
        if (validatedData.project_id) {
            const { data: project, error: projectError } = await supabase.from("projects").select("id, name").eq("id", validatedData.project_id).single();
            if (projectError || !project) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Project not found"
                }, {
                    status: 404
                });
            }
        }
        // Verify category exists if category_id is provided
        if (validatedData.category_id) {
            const { data: category, error: categoryError } = await supabase.from("document_categories").select("id, code").eq("id", validatedData.category_id).single();
            if (categoryError || !category) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Document category not found"
                }, {
                    status: 404
                });
            }
        }
        // Verify user exists if uploaded_by is provided
        if (validatedData.uploaded_by) {
            const { data: user, error: userError } = await supabase.from("users").select("id, first_name, last_name").eq("id", validatedData.uploaded_by).single();
            if (userError || !user) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "User not found"
                }, {
                    status: 404
                });
            }
        }
        // Check for duplicate filename in the same project (if both are provided)
        if (validatedData.project_id && validatedData.filename) {
            const { data: existingDoc, error: duplicateError } = await supabase.from("documents").select("id").eq("project_id", validatedData.project_id).eq("filename", validatedData.filename).eq("is_active", true).maybeSingle();
            if (duplicateError) {
                console.error("Duplicate check error:", duplicateError);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Failed to check for duplicate document"
                }, {
                    status: 500
                });
            }
            if (existingDoc) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Document with this filename already exists in the project"
                }, {
                    status: 409
                });
            }
        }
        // Create document record in Supabase
        const documentData = {
            ...validatedData,
            upload_date: new Date().toISOString()
        };
        const { data: document, error } = await supabase.from("documents").insert([
            documentData
        ]).select(`
        id,
        project_id,
        filename,
        original_filename,
        file_type,
        file_size,
        document_type,
        category_id,
        description,
        upload_date,
        uploaded_by,
        is_active,
        created_at,
        updated_at,
        projects(id, name, city),
        document_categories(id, code, name_de, name_ru, name_en),
        users:users!documents_uploaded_by_fkey(id, first_name, last_name, email)
      `).single();
        if (error) {
            console.error("Supabase error creating document:", error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Failed to create document record in database"
            }, {
                status: 500
            });
        }
        // Enhanced response data
        const project = Array.isArray(document.projects) ? document.projects[0] : document.projects;
        const category = Array.isArray(document.document_categories) ? document.document_categories[0] : document.document_categories;
        const uploader = Array.isArray(document.users) ? document.users[0] : document.users;
        const enhancedDocument = {
            ...document,
            project_name: project?.name || "No Project",
            project_city: project?.city || "Unknown City",
            category_name: category?.name_en || category?.name_de || "Uncategorized",
            category_code: category?.code || null,
            uploader_name: uploader ? `${uploader.first_name} ${uploader.last_name}` : "Unknown User",
            uploader_email: uploader?.email || null,
            file_size_mb: document.file_size ? (document.file_size / (1024 * 1024)).toFixed(2) : null
        };
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: "Document created successfully",
            document: enhancedDocument
        }, {
            status: 201
        });
    } catch (error) {
        console.error("Create document error:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to create document"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__c5c71d8d._.js.map