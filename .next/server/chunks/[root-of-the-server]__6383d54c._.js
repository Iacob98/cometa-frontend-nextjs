module.exports = [
"[project]/.next-internal/server/app/api/financial/summary/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/src/app/api/financial/summary/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
;
;
const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://oijmohlhdxoawzvctnxx.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pam1vaGxoZHhvYXd6dmN0bnh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODUzMjcsImV4cCI6MjA3MDg2MTMyN30.vw9G5hcSfd-m5AZqeGlmzGvqc9ImYioDFR-AsiHoFro"));
async function GET(request) {
    try {
        const { searchParams } = new URL(request.url);
        const project_id = searchParams.get('project_id');
        const start_date = searchParams.get('start_date');
        const end_date = searchParams.get('end_date');
        const year = searchParams.get('year');
        const month = searchParams.get('month');
        // Build base queries for costs and transactions
        let costsQuery = supabase.from('costs').select(`
        id,
        project_id,
        cost_type,
        date,
        amount_eur,
        description,
        reference_type,
        reference_id,
        created_at,
        project:projects!costs_project_id_fkey(
          id,
          name,
          city
        )
      `);
        let transactionsQuery = supabase.from('transactions').select(`
        id,
        project_id,
        amount,
        transaction_type,
        description,
        date,
        reference_id,
        created_at,
        project:projects!transactions_project_id_fkey(
          id,
          name,
          city
        )
      `);
        // Apply filters
        if (project_id) {
            costsQuery = costsQuery.eq('project_id', project_id);
            transactionsQuery = transactionsQuery.eq('project_id', project_id);
        }
        if (start_date && end_date) {
            costsQuery = costsQuery.gte('date', start_date).lte('date', end_date);
            transactionsQuery = transactionsQuery.gte('date', start_date).lte('date', end_date);
        } else if (year) {
            const yearStart = `${year}-01-01`;
            const yearEnd = `${year}-12-31`;
            costsQuery = costsQuery.gte('date', yearStart).lte('date', yearEnd);
            transactionsQuery = transactionsQuery.gte('date', yearStart).lte('date', yearEnd);
            if (month) {
                const monthStr = month.padStart(2, '0');
                const monthStart = `${year}-${monthStr}-01`;
                const monthEnd = new Date(parseInt(year), parseInt(month), 0);
                const monthEndStr = `${year}-${monthStr}-${monthEnd.getDate().toString().padStart(2, '0')}`;
                costsQuery = costsQuery.gte('date', monthStart).lte('date', monthEndStr);
                transactionsQuery = transactionsQuery.gte('date', monthStart).lte('date', monthEndStr);
            }
        }
        // Execute queries
        const [costsResult, transactionsResult] = await Promise.all([
            costsQuery,
            transactionsQuery
        ]);
        if (costsResult.error) {
            console.error('Supabase costs query error:', costsResult.error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch costs data'
            }, {
                status: 500
            });
        }
        if (transactionsResult.error) {
            console.error('Supabase transactions query error:', transactionsResult.error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch transactions data'
            }, {
                status: 500
            });
        }
        const costs = costsResult.data || [];
        const transactions = transactionsResult.data || [];
        // Calculate costs summary by type
        const costsByType = costs.reduce((acc, cost)=>{
            const type = cost.cost_type || 'other';
            if (!acc[type]) {
                acc[type] = {
                    type,
                    total: 0,
                    count: 0,
                    items: []
                };
            }
            acc[type].total += Number(cost.amount_eur) || 0;
            acc[type].count += 1;
            acc[type].items.push(cost);
            return acc;
        }, {});
        // Calculate transactions summary by type
        const transactionsByType = transactions.reduce((acc, transaction)=>{
            const type = transaction.transaction_type || 'expense';
            if (!acc[type]) {
                acc[type] = {
                    type,
                    total: 0,
                    count: 0,
                    items: []
                };
            }
            acc[type].total += Number(transaction.amount) || 0;
            acc[type].count += 1;
            acc[type].items.push(transaction);
            return acc;
        }, {});
        // Calculate totals
        const totalCosts = costs.reduce((sum, cost)=>sum + (Number(cost.amount_eur) || 0), 0);
        const totalIncome = transactionsByType.income?.total || 0;
        const totalExpenses = transactionsByType.expense?.total || 0;
        const totalTransactions = totalIncome + totalExpenses;
        // Calculate monthly breakdown if year is specified
        let monthlyBreakdown = null;
        if (year) {
            const monthlyData = Array.from({
                length: 12
            }, (_, i)=>{
                const month = i + 1;
                const monthStr = month.toString().padStart(2, '0');
                const monthlyCosts = costs.filter((cost)=>{
                    const costDate = new Date(cost.date);
                    return costDate.getMonth() + 1 === month;
                }).reduce((sum, cost)=>sum + (Number(cost.amount_eur) || 0), 0);
                const monthlyIncome = transactions.filter((t)=>{
                    const tDate = new Date(t.date);
                    return tDate.getMonth() + 1 === month && t.transaction_type === 'income';
                }).reduce((sum, t)=>sum + (Number(t.amount) || 0), 0);
                const monthlyExpenses = transactions.filter((t)=>{
                    const tDate = new Date(t.date);
                    return tDate.getMonth() + 1 === month && t.transaction_type === 'expense';
                }).reduce((sum, t)=>sum + (Number(t.amount) || 0), 0);
                return {
                    month,
                    monthName: new Date(parseInt(year), i, 1).toLocaleString('en', {
                        month: 'long'
                    }),
                    costs: monthlyCosts,
                    income: monthlyIncome,
                    expenses: monthlyExpenses,
                    net: monthlyIncome - monthlyExpenses - monthlyCosts
                };
            });
            monthlyBreakdown = monthlyData;
        }
        // Get project summaries if no specific project is filtered
        let projectSummaries = null;
        if (!project_id) {
            const projectCosts = costs.reduce((acc, cost)=>{
                const pId = cost.project_id;
                if (!acc[pId]) {
                    acc[pId] = {
                        project_id: pId,
                        project_name: cost.project?.name || 'Unknown Project',
                        project_city: cost.project?.city || '',
                        total_costs: 0,
                        costs_count: 0
                    };
                }
                acc[pId].total_costs += Number(cost.amount_eur) || 0;
                acc[pId].costs_count += 1;
                return acc;
            }, {});
            const projectTransactions = transactions.reduce((acc, transaction)=>{
                const pId = transaction.project_id;
                if (!acc[pId]) {
                    acc[pId] = {
                        project_id: pId,
                        project_name: transaction.project?.name || 'Unknown Project',
                        project_city: transaction.project?.city || '',
                        total_income: 0,
                        total_expenses: 0,
                        transactions_count: 0
                    };
                }
                if (transaction.transaction_type === 'income') {
                    acc[pId].total_income += Number(transaction.amount) || 0;
                } else {
                    acc[pId].total_expenses += Number(transaction.amount) || 0;
                }
                acc[pId].transactions_count += 1;
                return acc;
            }, {});
            // Merge project data
            const allProjectIds = new Set([
                ...Object.keys(projectCosts),
                ...Object.keys(projectTransactions)
            ]);
            projectSummaries = Array.from(allProjectIds).map((pId)=>{
                const costData = projectCosts[pId] || {};
                const transactionData = projectTransactions[pId] || {};
                return {
                    project_id: pId,
                    project_name: costData.project_name || transactionData.project_name || 'Unknown Project',
                    project_city: costData.project_city || transactionData.project_city || '',
                    total_costs: costData.total_costs || 0,
                    total_income: transactionData.total_income || 0,
                    total_expenses: transactionData.total_expenses || 0,
                    net_profit: (transactionData.total_income || 0) - (transactionData.total_expenses || 0) - (costData.total_costs || 0),
                    costs_count: costData.costs_count || 0,
                    transactions_count: transactionData.transactions_count || 0
                };
            });
        }
        // Recent activity (last 10 items)
        const recentActivity = [
            ...costs.map((cost)=>({
                    id: cost.id,
                    type: 'cost',
                    subtype: cost.cost_type,
                    amount: Number(cost.amount_eur) || 0,
                    description: cost.description || `${cost.cost_type} cost`,
                    date: cost.date,
                    project: cost.project?.name || 'Unknown Project',
                    created_at: cost.created_at
                })),
            ...transactions.map((transaction)=>({
                    id: transaction.id,
                    type: 'transaction',
                    subtype: transaction.transaction_type,
                    amount: Number(transaction.amount) || 0,
                    description: transaction.description || `${transaction.transaction_type} transaction`,
                    date: transaction.date,
                    project: transaction.project?.name || 'Unknown Project',
                    created_at: transaction.created_at
                }))
        ].sort((a, b)=>new Date(b.created_at).getTime() - new Date(a.created_at).getTime()).slice(0, 10);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            summary: {
                total_costs: totalCosts,
                total_income: totalIncome,
                total_expenses: totalExpenses,
                total_transactions: totalTransactions,
                net_profit: totalIncome - totalExpenses - totalCosts,
                costs_count: costs.length,
                transactions_count: transactions.length
            },
            costs_by_type: Object.values(costsByType).map((item)=>({
                    type: item.type,
                    total: item.total,
                    count: item.count,
                    percentage: totalCosts > 0 ? (item.total / totalCosts * 100).toFixed(2) : 0
                })),
            transactions_by_type: Object.values(transactionsByType).map((item)=>({
                    type: item.type,
                    total: item.total,
                    count: item.count,
                    percentage: totalTransactions > 0 ? (item.total / totalTransactions * 100).toFixed(2) : 0
                })),
            monthly_breakdown: monthlyBreakdown,
            project_summaries: projectSummaries,
            recent_activity: recentActivity,
            filters: {
                project_id,
                start_date,
                end_date,
                year,
                month
            }
        });
    } catch (error) {
        console.error('Financial summary API error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error',
            details: error instanceof Error ? error.message : 'Unknown error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__6383d54c._.js.map