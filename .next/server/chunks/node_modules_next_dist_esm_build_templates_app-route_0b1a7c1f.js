module.exports=[80942,e=>{"use strict";e.s(["handler",()=>D,"patchFetch",()=>N,"routeModule",()=>I,"serverHooks",()=>b,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>j],80942);var t=e.i(47909),r=e.i(74017),a=e.i(96250),o=e.i(59756),n=e.i(61916),s=e.i(69741),i=e.i(16795),l=e.i(87718),c=e.i(95169),u=e.i(47587),d=e.i(66012),p=e.i(70101),m=e.i(26937),_=e.i(10372),h=e.i(93695);e.i(52474);var g=e.i(220);e.s(["GET",()=>x,"OPTIONS",()=>T,"POST",()=>A,"revalidate",()=>C],10304);var f=e.i(89171),w=e.i(44070);async function R(){let e=performance.now();try{let{data:t,error:r}=await w.supabase.from("projects").select(`
        id,
        name,
        customer,
        city,
        address,
        contact_24h,
        start_date,
        end_date_plan,
        status,
        total_length_m,
        base_rate_per_m,
        pm_user_id,
        language_default,
        pm_user:users!pm_user_id(
          first_name,
          last_name
        ),
        work_entries(duration_hours)
      `).eq("status","active").order("start_date",{ascending:!1}).limit(20);if(r)throw r;let a=(t||[]).map(e=>{let t=(e.work_entries||[]).reduce((e,t)=>e+(t.duration_hours||0),0);return{...e,pm_user:Array.isArray(e.pm_user)?e.pm_user[0]:e.pm_user,progress:{completed_hours:t,progress_percentage:e.total_length_m?t/e.total_length_m*100:0},work_entries:void 0}}),o=performance.now()-e;return{data:a,error:null,executionTime:o}}catch(r){let t=performance.now()-e;return console.error("ðŸ”´ Super optimized query error:",r),{data:null,error:r,executionTime:t}}}async function v(){let e=performance.now();try{let{data:t,error:r}=await w.supabase.from("projects").select(`
        id,
        name,
        customer,
        city,
        address,
        contact_24h,
        start_date,
        end_date_plan,
        status,
        total_length_m,
        base_rate_per_m,
        pm_user_id,
        language_default,
        pm_user:users!pm_user_id(
          first_name,
          last_name
        )
      `).eq("status","active").order("start_date",{ascending:!1}).limit(20);if(r)throw r;if(!t?.length)return{data:[],error:null,executionTime:performance.now()-e};let a=t.map(e=>e.id);if(0===a.length)return{data:[],error:null,executionTime:performance.now()-e};let{data:o,error:n}=await w.supabase.from("work_entries").select("project_id, duration_hours").in("project_id",a).not("duration_hours","is",null).order("project_id");if(n)throw n;let s=new Map;o?.forEach(e=>{let t=s.get(e.project_id)||0;s.set(e.project_id,t+(e.duration_hours||0))});let i=t.map(e=>({...e,pm_user:Array.isArray(e.pm_user)?e.pm_user[0]:e.pm_user,progress:{completed_hours:s.get(e.id)||0,progress_percentage:e.total_length_m?(s.get(e.id)||0)/e.total_length_m*100:0}})),l=performance.now()-e;return{data:i,error:null,executionTime:l}}catch(r){let t=performance.now()-e;return console.error("ðŸ”´ Optimized query error:",r),{data:null,error:r,executionTime:t}}}async function E(){let e=performance.now();try{console.log("ðŸš€ Using PostgreSQL RPC function for maximum performance");let{data:t,error:r}=await w.supabase.rpc("get_projects_with_progress_optimized",{project_limit:20,project_offset:0});if(r)throw r;let a=(t||[]).map(e=>({id:e.id,name:e.name,customer:e.customer,city:e.city,address:e.address,contact_24h:e.contact_24h,start_date:e.start_date,end_date_plan:e.end_date_plan,status:e.status,total_length_m:e.total_length_m,base_rate_per_m:e.base_rate_per_m,pm_user_id:e.pm_user_id,language_default:e.language_default,pm_user:e.pm_first_name?{first_name:e.pm_first_name,last_name:e.pm_last_name}:null,progress:{completed_hours:parseFloat(e.completed_hours)||0,progress_percentage:parseFloat(e.progress_percentage)||0}})),o=performance.now()-e;return console.log(`âœ… RPC Query executed in ${o}ms for ${a.length} projects`),{data:a,error:null,executionTime:o}}catch(r){let t=performance.now()-e;return console.error("ðŸ”´ RPC query error:",r),{data:null,error:r,executionTime:t}}}var y=e.i(65044);let C=300,P=(0,y.unstable_cache)(async()=>{console.log("ðŸŽ¯ Starting optimized query with Context7 fallback strategy");try{return console.log("ðŸš€ Attempting RPC function approach"),await E()}catch(e){console.log("âš ï¸ RPC failed, trying super optimized approach",e);try{return await R()}catch(e){return console.log("âš ï¸ Super optimized failed, falling back to regular optimized",e),await v()}}},["projects-with-progress-v2"],{revalidate:300,tags:["projects","work-entries","rpc-optimized"]});async function x(e){let t=performance.now();try{console.log("ðŸš€ OPTIMIZED API ROUTE - Starting request");let{data:r,error:a,executionTime:o}=await P(),n=performance.now()-t;if(console.log(`ðŸ“Š OPTIMIZED API ROUTE Performance:`),console.log(`  - Database query time: ${o}ms`),console.log(`  - Total response time: ${n}ms`),console.log(`  - Projects returned: ${r?.length||0}`),console.log(`  - Cache status: ${e.headers.get("cache-control")||"default"}`),a)return console.error("âŒ OPTIMIZED API ROUTE Error:",a),f.NextResponse.json({error:"Failed to fetch projects",details:void 0},{status:500});let s=f.NextResponse.json({data:r||[],metadata:{count:r?.length||0,executionTime:o,totalTime:n,cached:!0,optimized:!0,timestamp:new Date().toISOString()}});return s.headers.set("Cache-Control","public, s-maxage=300, stale-while-revalidate=600"),s.headers.set("X-Database-Time",`${o}ms`),s.headers.set("X-Total-Time",`${n}ms`),s.headers.set("X-Optimized","true"),console.log("âœ… OPTIMIZED API ROUTE Success"),s}catch(r){let e=performance.now()-t;return console.error("âŒ OPTIMIZED API ROUTE Fatal Error:",r),console.log(`ðŸ’¥ Failed after: ${e}ms`),f.NextResponse.json({error:"Internal server error",metadata:{totalTime:e,optimized:!1,timestamp:new Date().toISOString()}},{status:500})}}async function A(t){try{let{revalidate:r}=await t.json();if(r){let{revalidateTag:t}=await e.A(19582);return t("projects"),t("work-entries"),console.log("ðŸ”„ CACHE INVALIDATED - Projects cache revalidated"),f.NextResponse.json({success:!0,message:"Cache invalidated successfully",timestamp:new Date().toISOString()})}return f.NextResponse.json({success:!1,message:"Invalid request - missing revalidate parameter"},{status:400})}catch(e){return console.error("âŒ CACHE REVALIDATION Error:",e),f.NextResponse.json({success:!1,error:"Failed to revalidate cache"},{status:500})}}async function T(e){if("true"===new URL(e.url).searchParams.get("health")){let e=performance.now();try{let{error:t}=await E(),r=performance.now()-e;return f.NextResponse.json({status:"healthy",optimized:!0,responseTime:`${r}ms`,timestamp:new Date().toISOString(),services:{supabase:t?"error":"healthy",cache:"enabled"}})}catch(e){return f.NextResponse.json({status:"unhealthy",error:"Service check failed",timestamp:new Date().toISOString()},{status:503})}}return f.NextResponse.json({methods:["GET","POST","OPTIONS"],description:"Optimized Projects API with Supabase integration"})}var O=e.i(10304);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/projects-optimized/route",pathname:"/api/projects-optimized",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/projects-optimized/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:S,workUnitAsyncStorage:j,serverHooks:b}=I;function N(){return(0,a.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:j})}async function D(e,t,a){var f;let w="/api/projects-optimized/route";w=w.replace(/\/index$/,"")||"/";let R=await I.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:y,isDraftMode:C,prerenderManifest:P,routerServerContext:x,isOnDemandRevalidate:A,revalidateOnlyGenerated:T,resolvedPathname:O}=R,S=(0,s.normalizeAppPath)(w),j=!!(P.dynamicRoutes[S]||P.routes[O]);if(j&&!C){let e=!!P.routes[O],t=P.dynamicRoutes[S];if(t&&!1===t.fallback&&!e)throw new h.NoFallbackError}let b=null;!j||I.isDev||C||(b="/index"===(b=O)?"/":b);let N=!0===I.isDev||!j,D=j&&!N,q=e.method||"GET",U=(0,n.getTracer)(),k=U.getActiveScopeSpan(),M={params:E,prerenderManifest:P,renderOpts:{experimental:{cacheComponents:!!y.experimental.cacheComponents,authInterrupts:!!y.experimental.authInterrupts},supportsDynamicResponse:N,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(f=y.experimental)?void 0:f.cacheLife,isRevalidate:D,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>I.onRequestError(e,t,a,x)},sharedContext:{buildId:v}},H=new i.NodeNextRequest(e),$=new i.NodeNextResponse(t),z=l.NextRequestAdapter.fromNodeNextRequest(H,(0,l.signalFromNodeResponse)(t));try{let s=async r=>I.handle(z,M).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=U.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=a.get("next.route");if(o){let e=`${q} ${o}`;r.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),r.updateName(e)}else r.updateName(`${q} ${e.url}`)}),i=async n=>{var i,l;let c=async({previousCacheEntry:r})=>{try{if(!(0,o.getRequestMeta)(e,"minimalMode")&&A&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=M.renderOpts.collectedTags;if(!j)return await (0,d.sendResponse)(H,$,i,M.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[_.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,a=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:D,isOnDemandRevalidate:A})},x),t}},h=await I.handleResponse({req:e,nextConfig:y,cacheKey:b,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:a.waitUntil});if(!j)return null;if((null==h||null==(i=h.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,o.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",A?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,p.fromNodeOutgoingHttpHeaders)(h.value.headers);return(0,o.getRequestMeta)(e,"minimalMode")&&j||f.delete(_.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(h.cacheControl)),await (0,d.sendResponse)(H,$,new Response(h.value.body,{headers:f,status:h.value.status||200})),null};k?await i(k):await U.withPropagatedContext(e.headers,()=>U.trace(c.BaseServerSpan.handleRequest,{spanName:`${q} ${e.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},i))}catch(t){if(k||t instanceof h.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:D,isOnDemandRevalidate:A})}),j)throw t;return await (0,d.sendResponse)(H,$,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0b1a7c1f.js.map