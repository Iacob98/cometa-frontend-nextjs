module.exports=[18622,(a,b,c)=>{b.exports=a.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},42602,(a,b,c)=>{"use strict";b.exports=a.r(18622)},87924,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].ReactJsxRuntime},72131,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].React},35112,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].ReactDOM},47507,a=>{"use strict";a.s(["initializeAuth",()=>l,"useAuth",()=>m,"useLogin",()=>n,"useLogout",()=>o,"usePermissions",()=>p,"useRequireAuth",()=>q]);var b=a.i(33217),c=a.i(70025),d=a.i(37927),e=a.i(23292),f=a.i(91938);let g={all:["auth"],user:()=>[...g.all,"user"],token:()=>[...g.all,"token"]},h="cometa_auth_token",i="cometa_refresh_token",j="cometa_user";function k(){localStorage.removeItem(h),localStorage.removeItem(i),localStorage.removeItem(j),document.cookie="cometa_auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",(0,f.clearAuthTokenForAllClients)()}function l(){}function m(){return(0,b.useQuery)({queryKey:g.user(),queryFn:()=>{throw Error("Not authenticated")},staleTime:1/0,retry:!1})}function n(){let a=(0,d.useQueryClient)();return(0,c.useMutation)({mutationFn:a=>f.authApi.login(a),onSuccess:b=>{localStorage.setItem(h,b.access_token),localStorage.setItem(i,b.refresh_token),localStorage.setItem(j,JSON.stringify({...b.user,permissions:b.permissions}));let c=new Date;c.setTime(c.getTime()+1e3*b.expires_in);let d="https:"===window.location.protocol;document.cookie=`cometa_auth_token=${b.access_token}; expires=${c.toUTCString()}; path=/; samesite=strict${d?"; secure":""}`,(0,f.setAuthTokenForAllClients)(b.access_token);let k={...b.user,permissions:b.permissions};a.setQueryData(g.user(),k),e.toast.success(`Welcome back, ${b.user.first_name}!`)},onError:a=>{e.toast.error(`Login failed: ${a.message}`)}})}function o(){let a=(0,d.useQueryClient)();return(0,c.useMutation)({mutationFn:()=>f.authApi.logout(),onSuccess:()=>{k(),a.removeQueries({queryKey:g.all}),a.clear(),e.toast.success("Logged out successfully")},onError:b=>{k(),a.removeQueries({queryKey:g.all}),a.clear(),e.toast.error("Logout failed")},onSettled:()=>{}})}function p(){let{data:a}=m(),b=b=>a?.role===b,c=b=>!!a?.role&&b.includes(a.role);return{user:a,hasPermission:b=>a?.permissions?.includes(b)??!1,hasRole:b,hasAnyRole:c,isAdmin:b("admin"),isProjectManager:b("pm"),isForeman:b("foreman"),isWorker:c(["crew","worker"]),isViewer:b("viewer"),canManageTeams:c(["admin","pm","foreman"]),canApproveWork:c(["admin","pm","foreman"]),canManageWork:c(["admin","pm","foreman","crew","worker"]),canViewFinances:c(["admin","pm","foreman"]),canManageFinances:c(["admin","pm"]),canManageInventory:c(["admin","pm","foreman"])}}function q(){let{data:a,isLoading:b,error:c}=m();return{user:a,isLoading:b,isAuthenticated:!!a&&!c,error:c}}},37844,a=>{"use strict";a.s(["WebSocketProvider",()=>i,"useWebSocket",()=>j]);var b=a.i(87924),c=a.i(72131),d=a.i(37927),e=a.i(23292),f=a.i(47507),g=a.i(91938);let h=(0,c.createContext)(null);function i({children:a}){let{user:i,token:j}=(0,f.useAuth)(),k=(0,d.useQueryClient)(),l=(0,c.useRef)(!1),m=(0,c.useRef)(0),n=c.default.useCallback(a=>{k.invalidateQueries({queryKey:["notifications"]}),i?.id&&k.invalidateQueries({queryKey:["notifications","unread-count",i.id]}),k.setQueryData(["notifications","detail",a.id],a),("high"===a.priority||"urgent"===a.priority)&&e.toast.info(a.title,{description:a.body,action:"urgent"===a.priority?{label:"View",onClick:()=>{console.log("Navigate to notification:",a.id)}}:void 0})},[k,i?.id]),o=c.default.useCallback(a=>{switch(console.log("Realtime update received:",a),a.entity_type){case"project":k.invalidateQueries({queryKey:["projects"]}),a.entity_id&&k.invalidateQueries({queryKey:["projects","detail",a.entity_id]});break;case"work_entry":k.invalidateQueries({queryKey:["work-entries"]}),a.entity_id&&k.invalidateQueries({queryKey:["work-entries","detail",a.entity_id]});break;case"material":k.invalidateQueries({queryKey:["materials"]}),a.entity_id&&k.invalidateQueries({queryKey:["materials","detail",a.entity_id]});break;case"material_allocation":k.invalidateQueries({queryKey:["material-allocations"]});break;case"house":k.invalidateQueries({queryKey:["houses"]}),a.entity_id&&k.invalidateQueries({queryKey:["houses","detail",a.entity_id]});break;case"appointment":k.invalidateQueries({queryKey:["appointments"]}),a.entity_id&&k.invalidateQueries({queryKey:["appointments","detail",a.entity_id]});break;case"crew":k.invalidateQueries({queryKey:["crews"]}),a.entity_id&&k.invalidateQueries({queryKey:["crews","detail",a.entity_id]});break;default:console.log("Unknown entity type for realtime update:",a.entity_type)}if("status_changed"===a.type&&a.data?.status){let b=a.entity_type.replace("_"," ");e.toast.info(`${b} status updated`,{description:`Status changed to: ${a.data.status}`})}if("assignment_changed"===a.type&&i?.id&&a.data?.assigned_to===i.id){let b=a.entity_type.replace("_"," ");e.toast.info(`New ${b} assigned`,{description:`You have been assigned to a ${b}`})}},[k,i?.id]),p=c.default.useCallback(a=>{console.log("User status update:",a)},[]),q=c.default.useCallback(a=>{console.log("Typing indicator:",a)},[]),r=c.default.useCallback(async()=>{if(i?.id&&j)try{g.wsApi.setAuthToken(j),await g.wsApi.connect(i.id),l.current=!0,m.current=0,console.log("WebSocket connected successfully"),g.wsApi.subscribe("notification",n),g.wsApi.subscribe("realtime_update",o),g.wsApi.subscribe("user_status",p),g.wsApi.subscribe("typing_indicator",q),g.wsApi.send("user_status",{status:"online",timestamp:new Date().toISOString()})}catch(a){if(console.error("WebSocket connection failed:",a),l.current=!1,m.current<5){m.current++;let a=1e3*Math.pow(2,m.current);console.log(`Retrying WebSocket connection in ${a}ms (attempt ${m.current}/5)`),setTimeout(()=>{r()},a)}else console.error("Max WebSocket connection attempts reached"),e.toast.error("Failed to establish real-time connection",{description:"Some features may not work properly. Please refresh the page."})}},[i?.id,j,n,o,p,q]),s=c.default.useCallback(()=>{l.current&&(g.wsApi.send("user_status",{status:"offline",timestamp:new Date().toISOString()}),g.wsApi.unsubscribe("notification",n),g.wsApi.unsubscribe("realtime_update",o),g.wsApi.unsubscribe("user_status",p),g.wsApi.unsubscribe("typing_indicator",q),g.wsApi.disconnect(),l.current=!1,m.current=0,console.log("WebSocket disconnected"))},[n,o,p,q]);(0,c.useEffect)(()=>(i?.id&&j?r():s(),()=>{s()}),[i?.id,j,r,s]),(0,c.useEffect)(()=>{let a=()=>{document.hidden?l.current&&g.wsApi.send("user_status",{status:"away",timestamp:new Date().toISOString()}):i?.id&&j&&(l.current?g.wsApi.send("user_status",{status:"online",timestamp:new Date().toISOString()}):r())};return document.addEventListener("visibilitychange",a),()=>{document.removeEventListener("visibilitychange",a)}},[i?.id,j,r]),(0,c.useEffect)(()=>{let a=()=>{l.current&&g.wsApi.send("user_status",{status:"offline",timestamp:new Date().toISOString()})};return window.addEventListener("beforeunload",a),()=>{window.removeEventListener("beforeunload",a)}},[]);let t={isConnected:l.current,send:(a,b)=>{l.current?g.wsApi.send(a,b):console.warn("WebSocket not connected, cannot send message:",{type:a,data:b})},subscribe:(a,b)=>{g.wsApi.subscribe(a,b)},unsubscribe:(a,b)=>{g.wsApi.unsubscribe(a,b)}};return(0,b.jsx)(h.Provider,{value:t,children:a})}function j(){let a=(0,c.useContext)(h);if(!a)throw Error("useWebSocket must be used within a WebSocketProvider");return a}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__50f89850._.js.map